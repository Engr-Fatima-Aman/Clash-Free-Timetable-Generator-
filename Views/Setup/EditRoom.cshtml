@model dsa_project.Models.Room

@{
    ViewData["Title"] = "Edit Room";
}

<link rel="stylesheet" href="~/css/main.css">
<link rel="stylesheet" href="~/css/components.css">
<link rel="stylesheet" href="~/css/forms.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<div class="form-section">
    <div class="container">
        <div class="form-container">
            <!-- Form Steps -->
            <div class="form-steps mb-4">
                <div class="form-step">
                    <div class="step-number active">1</div>
                    <div class="step-label">Room Details</div>
                </div>
                <div class="form-step">
                    <div class="step-number">2</div>
                    <div class="step-label">Capacity & Type</div>
                </div>
                <div class="form-step">
                    <div class="step-number">3</div>
                    <div class="step-label">Review & Update</div>
                </div>
            </div>

            <!-- Main Form Card -->
            <div class="form-card form-room">
                <div class="form-header">
                    <h1 class="form-title">
                        <i class="fas fa-edit"></i>
                        Edit Room
                    </h1>
                    <div class="text-center mt-2" style="color: rgba(255,255,255,0.9); font-size: 0.9rem;">
                        <i class="fas fa-info-circle"></i>
                        Editing Room ID: <strong>#@Model.Id</strong>
                    </div>
                </div>

                <div class="form-body">
                    <form asp-action="EditRoom" method="post" id="editRoomForm">
                        <input type="hidden" asp-for="Id" />
                        
                        <div class="form-grid">
                            <!-- Room Number -->
                            <div class="mb-3">
                                <label class="form-label">
                                    <i class="fas fa-hashtag"></i>
                                    Room Number
                                </label>
                                <input asp-for="RoomNumber" 
                                       class="form-control form-control-lg" 
                                       placeholder="e.g. Room-101 or Lab-01" 
                                       required 
                                       oninput="updatePreview()" />
                                <div class="form-hint">
                                    <i class="fas fa-info-circle"></i>
                                    Clear identifier for scheduling
                                </div>
                            </div>

                            <!-- Room Capacity -->
                            <div class="mb-3">
                                <label class="form-label">
                                    <i class="fas fa-user-friends"></i>
                                    Capacity
                                </label>
                                <input asp-for="Capacity" 
                                       type="number" 
                                       class="form-control form-control-lg" 
                                       placeholder="e.g. 50" 
                                       required 
                                       min="1" 
                                       max="500"
                                       oninput="updatePreview()" />
                                <div class="form-hint">
                                    <i class="fas fa-users"></i>
                                    Maximum number of students
                                </div>
                                
                                <!-- Capacity Indicator -->
                                <div class="room-capacity-info">
                                    <div style="font-size: 0.85rem; color: #64748b; white-space: nowrap;">
                                        Capacity:
                                    </div>
                                    <div class="capacity-indicator">
                                        <div class="capacity-fill" id="capacityFill" style="width: 0%"></div>
                                    </div>
                                    <div style="font-size: 0.85rem; color: #2c3e50; font-weight: 500;">
                                        <span id="capacityText">0</span> seats
                                    </div>
                                </div>
                            </div>

                            <!-- Room Type Selection -->
                            <div class="mb-4">
                                <label class="form-label">
                                    <i class="fas fa-building"></i>
                                    Room Type
                                </label>
                                <div class="form-type-selector">
                                    <div class="form-type-option @(!Model.IsLabRoom ? "active" : "")" 
                                         onclick="selectRoomType('classroom')" 
                                         id="classroomOption">
                                        <i class="fas fa-chalkboard-teacher"></i>
                                        <div>Classroom</div>
                                        <small class="text-muted">Regular lecture room</small>
                                    </div>
                                    <div class="form-type-option @(Model.IsLabRoom ? "active" : "")" 
                                         onclick="selectRoomType('lab')" 
                                         id="labOption">
                                        <i class="fas fa-flask"></i>
                                        <div>Laboratory</div>
                                        <small class="text-muted">Computer/Science lab</small>
                                    </div>
                                </div>
                                <input type="hidden" asp-for="IsLabRoom" id="isLabRoomInput" value="@Model.IsLabRoom.ToString().ToLower()" />
                                <div class="form-hint mt-2">
                                    <i class="fas fa-lightbulb"></i>
                                    <span id="typeHint">
                                        @(Model.IsLabRoom ? "Labs are for practical sessions and require specialized equipment." : "Classrooms are for regular lectures and can host multiple classes.")
                                    </span>
                                </div>
                            </div>
                        </div>

                        <!-- Lab Room Info (Shown only for labs) -->
                        <div class="lab-hours-field" id="labRoomField" style="@(Model.IsLabRoom ? "display: block;" : "display: none;")">
                            <div class="d-flex align-items-center gap-3">
                                <div style="font-size: 2rem; color: #9b59b6;">
                                    <i class="fas fa-flask"></i>
                                </div>
                                <div>
                                    <h6 class="mb-1" style="color: #8e44ad;">
                                        <i class="fas fa-info-circle"></i>
                                        Laboratory Room Information
                                    </h6>
                                    <p class="mb-0" style="color: #666; font-size: 0.9rem;">
                                        This room is reserved for lab courses only. Ensure it has necessary equipment
                                        and is available for 3-hour continuous slots.
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Warning Alert -->
                        <div class="alert" style="background: rgba(243, 156, 18, 0.1); border-left-color: #f39c12; color: #d35400;">
                            <div class="d-flex align-items-center gap-2">
                                <i class="fas fa-exclamation-triangle"></i>
                                <div>
                                    <strong>Note:</strong> 
                                    <span class="ms-1">Changing room type may affect existing timetables. Ensure course assignments are updated accordingly.</span>
                                </div>
                            </div>
                        </div>

                        <!-- Room Preview -->
                        <div class="preview-card">
                            <div class="preview-title">
                                <i class="fas fa-eye"></i>
                                Room Preview
                            </div>
                            <div class="preview-content" id="roomPreview">
                                <div class="preview-item">
                                    <div class="preview-label">Room Number</div>
                                    <div class="preview-value" id="previewNumber">@Model.RoomNumber</div>
                                </div>
                                <div class="preview-item">
                                    <div class="preview-label">Capacity</div>
                                    <div class="preview-value" id="previewCapacity">@Model.Capacity seats</div>
                                </div>
                                <div class="preview-item">
                                    <div class="preview-label">Room Type</div>
                                    <div class="preview-value" id="previewType">@(Model.IsLabRoom ? "Laboratory" : "Classroom")</div>
                                </div>
                                <div class="preview-item">
                                    <div class="preview-label">Suitable For</div>
                                    <div class="preview-value" id="previewSuitable">@(Model.IsLabRoom ? "Lab courses only" : "Theory courses")</div>
                                </div>
                                <div class="preview-item">
                                    <div class="preview-label">Max Class Size</div>
                                    <div class="preview-value" id="previewMaxClass">-</div>
                                </div>
                            </div>
                        </div>

                        <!-- Form Actions -->
                        <div class="form-actions">
                            <button type="submit" class="btn-submit">
                                <i class="fas fa-save"></i>
                                Update Room
                            </button>
                            <a asp-action="Manage" class="btn-back">
                                <i class="fas fa-times"></i>
                                Cancel
                            </a>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Help Section -->
            <div class="card mt-4" style="border: 1px solid #e2e8f0; border-radius: 12px;">
                <div class="card-body">
                    <h5 class="card-title" style="color: #2c3e50;">
                        <i class="fas fa-question-circle text-primary me-2"></i>
                        Room Editing Guidelines
                    </h5>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <h6 class="fw-bold" style="color: #e74c3c;">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    Important Notes
                                </h6>
                                <ul class="list-unstyled small mb-0">
                                    <li class="mb-1">
                                        <i class="fas fa-check text-success me-2"></i>
                                        Changes affect scheduled classes
                                    </li>
                                    <li class="mb-1">
                                        <i class="fas fa-check text-success me-2"></i>
                                        Type changes require course reassignment
                                    </li>
                                    <li class="mb-1">
                                        <i class="fas fa-check text-success me-2"></i>
                                        Capacity changes affect student allocation
                                    </li>
                                    <li>
                                        <i class="fas fa-check text-success me-2"></i>
                                        Re-generate timetable after updates
                                    </li>
                                </ul>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <h6 class="fw-bold" style="color: #27ae60;">
                                    <i class="fas fa-lightbulb me-2"></i>
                                    Best Practices
                                </h6>
                                <ul class="list-unstyled small mb-0">
                                    <li class="mb-1">
                                        <i class="fas fa-check text-success me-2"></i>
                                        Update before generating schedules
                                    </li>
                                    <li class="mb-1">
                                        <i class="fas fa-check text-success me-2"></i>
                                        Verify capacity matches class sizes
                                    </li>
                                    <li class="mb-1">
                                        <i class="fas fa-check text-success me-2"></i>
                                        Ensure lab rooms have equipment
                                    </li>
                                    <li>
                                        <i class="fas fa-check text-success me-2"></i>
                                        Review changes in preview
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <h6 class="fw-bold" style="color: #2c3e50;">
                            <i class="fas fa-ruler-combined me-2"></i>
                            Room Configuration Standards
                        </h6>
                        <table class="table table-sm mb-0">
                            <thead>
                                <tr>
                                    <th>Room Type</th>
                                    <th>Capacity Range</th>
                                    <th>Slot Duration</th>
                                    <th>Courses Assigned</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Small Classroom</td>
                                    <td>20-40 seats</td>
                                    <td>1-2 hours</td>
                                    <td>Tutorials/Seminars</td>
                                </tr>
                                <tr>
                                    <td>Standard Classroom</td>
                                    <td>40-80 seats</td>
                                    <td>1-3 hours</td>
                                    <td>Regular Lectures</td>
                                </tr>
                                <tr>
                                    <td>Large Classroom</td>
                                    <td>80-150 seats</td>
                                    <td>2-3 hours</td>
                                    <td>Mass Lectures</td>
                                </tr>
                                <tr>
                                    <td>Computer Lab</td>
                                    <td>20-40 seats</td>
                                    <td>3 hours continuous</td>
                                    <td>Programming Labs</td>
                                </tr>
                                <tr>
                                    <td>Science Lab</td>
                                    <td>15-30 seats</td>
                                    <td>3 hours continuous</td>
                                    <td>Experiments</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize room type selection
        const isLabRoomInput = document.getElementById('isLabRoomInput');
        const labRoomField = document.getElementById('labRoomField');
        const capacityFill = document.getElementById('capacityFill');
        const capacityText = document.getElementById('capacityText');
        const typeHint = document.getElementById('typeHint');
        
        // Update capacity indicator
        function updateCapacityIndicator(capacity) {
            const cap = parseInt(capacity) || 0;
            
            // Calculate percentage (max 500 for 100%)
            const percentage = Math.min((cap / 500) * 100, 100);
            capacityFill.style.width = percentage + '%';
            capacityText.textContent = cap;
            
            // Update color based on capacity
            if (cap < 20) {
                capacityFill.style.background = 'linear-gradient(90deg, #e74c3c, #c0392b)';
            } else if (cap < 50) {
                capacityFill.style.background = 'linear-gradient(90deg, #f39c12, #e67e22)';
            } else if (cap < 100) {
                capacityFill.style.background = 'linear-gradient(90deg, #2ecc71, #27ae60)';
            } else {
                capacityFill.style.background = 'linear-gradient(90deg, #3498db, #2980b9)';
            }
        }
        
        // Function to select room type
        window.selectRoomType = function(type) {
            const classroomOption = document.getElementById('classroomOption');
            const labOption = document.getElementById('labOption');
            
            // Update UI
            classroomOption.classList.remove('active');
            labOption.classList.remove('active');
            
            if (type === 'classroom') {
                classroomOption.classList.add('active');
                isLabRoomInput.value = 'false';
                labRoomField.style.display = 'none';
                typeHint.innerHTML = 'Classrooms are for regular lectures and can host multiple small classes.';
            } else {
                labOption.classList.add('active');
                isLabRoomInput.value = 'true';
                labRoomField.style.display = 'block';
                typeHint.innerHTML = 'Labs are for practical sessions and require specialized equipment.';
            }
            
            updatePreview();
        };
        
        // Initialize room type based on model
        if (@Model.IsLabRoom.ToString().ToLower() === 'true') {
            selectRoomType('lab');
        } else {
            selectRoomType('classroom');
        }
        
        // Update preview function
        window.updatePreview = function() {
            const numberInput = document.querySelector('input[asp-for="RoomNumber"]');
            const capacityInput = document.querySelector('input[asp-for="Capacity"]');
            const isLabRoom = isLabRoomInput.value === 'true';
            const capacity = parseInt(capacityInput.value) || @Model.Capacity;
            
            // Update preview values
            document.getElementById('previewNumber').textContent = numberInput.value || '@Model.RoomNumber';
            document.getElementById('previewCapacity').textContent = capacity ? capacity + ' seats' : '@Model.Capacity seats';
            document.getElementById('previewType').textContent = isLabRoom ? 'Laboratory' : 'Classroom';
            document.getElementById('previewSuitable').textContent = isLabRoom ? 'Lab courses only' : 'Theory courses';
            
            // Determine max class size recommendation
            let maxClassSize = '-';
            if (capacity > 0) {
                if (isLabRoom) {
                    // Labs usually work with smaller groups
                    maxClassSize = Math.min(capacity, 30) + ' students (lab sessions)';
                } else {
                    if (capacity < 30) {
                        maxClassSize = 'Small tutorials (up to ' + capacity + ' students)';
                    } else if (capacity < 60) {
                        maxClassSize = 'Regular classes (up to ' + capacity + ' students)';
                    } else {
                        maxClassSize = 'Large lectures (up to ' + capacity + ' students)';
                    }
                }
            }
            document.getElementById('previewMaxClass').textContent = maxClassSize;
            
            // Update capacity indicator
            updateCapacityIndicator(capacity);
            
            // Show warnings for unusual configurations
            const roomName = (numberInput.value || '@Model.RoomNumber').toLowerCase();
            const warning = document.querySelector('.alert');
            
            if (isLabRoom && capacity > 40) {
                if (warning) {
                    warning.innerHTML = `
                        <div class="d-flex align-items-center gap-2">
                            <i class="fas fa-exclamation-triangle"></i>
                            <div>
                                <strong>Warning:</strong> 
                                <span class="ms-1">Large laboratory room (${capacity} seats). Lab rooms typically have 20-40 seats.</span>
                            </div>
                        </div>
                    `;
                    warning.style.background = 'rgba(231, 76, 60, 0.1)';
                    warning.style.borderLeftColor = '#e74c3c';
                    warning.style.color = '#c0392b';
                }
            } else if (!isLabRoom && capacity < 20) {
                if (warning) {
                    warning.innerHTML = `
                        <div class="d-flex align-items-center gap-2">
                            <i class="fas fa-info-circle"></i>
                            <div>
                                <strong>Note:</strong> 
                                <span class="ms-1">Small classroom (${capacity} seats). Suitable for tutorials or small groups.</span>
                            </div>
                        </div>
                    `;
                    warning.style.background = 'rgba(52, 152, 219, 0.1)';
                    warning.style.borderLeftColor = '#3498db';
                    warning.style.color = '#2980b9';
                }
            }
            
            // Auto-detect room type mismatch
            if ((roomName.includes('lab') || roomName.includes('comp') || roomName.includes('science')) && !isLabRoom) {
                if (warning) {
                    warning.innerHTML = `
                        <div class="d-flex align-items-center gap-2">
                            <i class="fas fa-exclamation-triangle"></i>
                            <div>
                                <strong>Potential Mismatch:</strong> 
                                <span class="ms-1">Room name suggests laboratory but type is set to classroom.</span>
                            </div>
                        </div>
                    `;
                    warning.style.background = 'rgba(243, 156, 18, 0.1)';
                    warning.style.borderLeftColor = '#f39c12';
                    warning.style.color = '#d35400';
                }
            }
        };
        
        // Initialize preview
        updatePreview();
        
        // Form validation
        const form = document.getElementById('editRoomForm');
        form.addEventListener('submit', function(e) {
            const roomNumber = document.querySelector('input[asp-for="RoomNumber"]').value;
            const capacity = document.querySelector('input[asp-for="Capacity"]').value;
            
            // Basic validation
            if (!roomNumber || !capacity) {
                e.preventDefault();
                showAlert('Please fill in all required fields.', 'error');
                return false;
            }
            
            const capacityNum = parseInt(capacity);
            if (capacityNum < 1 || capacityNum > 500) {
                e.preventDefault();
                showAlert('Please enter valid capacity (1-500).', 'error');
                return false;
            }
            
            const isLabRoom = isLabRoomInput.value === 'true';
            const originalIsLabRoom = @Model.IsLabRoom.ToString().ToLower() === 'true';
            const originalCapacity = @Model.Capacity;
            
            // Warn about type changes
            if (isLabRoom !== originalIsLabRoom) {
                if (!confirm('⚠️ Warning: Changing room type from ' + (originalIsLabRoom ? 'Laboratory' : 'Classroom') + ' to ' + (isLabRoom ? 'Laboratory' : 'Classroom') + 
                           '.\n\nThis affects:\n• Course assignments\n• Slot durations\n• Equipment requirements\n\nAre you sure you want to change the room type?')) {
                    e.preventDefault();
                    return false;
                }
            }
            
            // Warn about capacity changes
            if (capacityNum !== originalCapacity) {
                if (!confirm('⚠️ Note: Changing capacity from ' + originalCapacity + ' to ' + capacityNum + 
                           '.\n\nThis affects class allocations and scheduling.\n\nContinue?')) {
                    e.preventDefault();
                    return false;
                }
            }
            
            // Validate lab room capacity
            if (isLabRoom && capacityNum > 40) {
                if (!confirm('⚠️ Warning: Large laboratory rooms (over 40 seats) are uncommon.\n\nLab rooms typically have 20-40 seats.\n\nAre you sure?')) {
                    e.preventDefault();
                    return false;
                }
            }
            
            // Check for name-type mismatch
            const roomName = roomNumber.toLowerCase();
            if (roomName.includes('room') && isLabRoom) {
                if (!confirm('⚠️ Warning: Room name contains "room" but marked as laboratory.\n\nIs this correct?')) {
                    e.preventDefault();
                    return false;
                }
            }
            
            return true;
        });
        
        // Helper function to show alerts
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type === 'error' ? 'danger' : 'success'} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            
            const formBody = document.querySelector('.form-body');
            const existingAlert = formBody.querySelector('.alert');
            if (existingAlert && !existingAlert.classList.contains('form-alert')) {
                existingAlert.remove();
            }
            
            formBody.insertBefore(alertDiv, formBody.firstChild);
            
            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentElement) {
                    alertDiv.remove();
                }
            }, 5000);
        }
        
        // Add input focus effects
        const inputs = document.querySelectorAll('.form-control');
        inputs.forEach(input => {
            input.addEventListener('focus', function() {
                this.parentElement.style.transform = 'translateY(-2px)';
            });
            
            input.addEventListener('blur', function() {
                this.parentElement.style.transform = 'translateY(0)';
            });
        });
        
        // Auto-detect room type from room number
        const roomNumberInput = document.querySelector('input[asp-for="RoomNumber"]');
        roomNumberInput.addEventListener('blur', function() {
            const roomName = this.value.toLowerCase();
            if (roomName.includes('lab') || roomName.includes('comp') || roomName.includes('science')) {
                if (!confirm('Room name suggests it might be a laboratory. Change room type to Laboratory?')) {
                    selectRoomType('lab');
                }
            } else if (roomName.includes('room') || roomName.includes('class') || roomName.includes('hall')) {
                if (!confirm('Room name suggests it might be a classroom. Change room type to Classroom?')) {
                    selectRoomType('classroom');
                }
            }
        });
        
        // Auto-format room number
        roomNumberInput.addEventListener('input', function() {
            const value = this.value;
            const isLabRoom = isLabRoomInput.value === 'true';
            
            // Suggest appropriate prefix
            if (value && !value.toLowerCase().includes('room') && !value.toLowerCase().includes('lab')) {
                const prefix = isLabRoom ? 'Lab-' : 'Room-';
                if (!value.startsWith(prefix)) {
                    // Don't auto-add, just update placeholder
                    this.setAttribute('placeholder', `${prefix}101`);
                }
            }
        });
        
        // Suggest typical capacity based on room type
        const capacityInput = document.querySelector('input[asp-for="Capacity"]');
        capacityInput.addEventListener('focus', function() {
            const isLabRoom = isLabRoomInput.value === 'true';
            if (isLabRoom) {
                this.setAttribute('placeholder', 'Typically 20-40 for labs');
            } else {
                this.setAttribute('placeholder', 'Typically 40-80 for classrooms');
            }
        });
    });
</script>