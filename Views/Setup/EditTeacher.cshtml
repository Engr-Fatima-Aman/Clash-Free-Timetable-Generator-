@model dsa_project.Models.Teacher

@{
    ViewData["Title"] = "Edit Teacher";
}

<link rel="stylesheet" href="~/css/main.css">
<link rel="stylesheet" href="~/css/components.css">
<link rel="stylesheet" href="~/css/forms.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<div class="form-section">
    <div class="container">
        <div class="form-container">
            <!-- Form Steps -->
            <div class="form-steps mb-4">
                <div class="form-step">
                    <div class="step-number active">1</div>
                    <div class="step-label">Basic Info</div>
                </div>
                <div class="form-step">
                    <div class="step-number">2</div>
                    <div class="step-label">Faculty Type</div>
                </div>
                <div class="form-step">
                    <div class="step-number">3</div>
                    <div class="step-label">Course Updates</div>
                </div>
            </div>

            <!-- Main Form Card -->
            <div class="form-card form-teacher">
                <div class="form-header">
                    <h1 class="form-title">
                        <i class="fas fa-edit"></i>
                        Edit Teacher
                    </h1>
                    <div class="text-center mt-2" style="color: rgba(255,255,255,0.9); font-size: 0.9rem;">
                        <i class="fas fa-info-circle"></i>
                        Editing Teacher ID: <strong>#@Model.Id</strong>
                    </div>
                </div>

                <div class="form-body">
                    <form asp-action="EditTeacher" method="post" id="editTeacherForm">
                        <input type="hidden" asp-for="Id" />
                        
                        <div class="form-grid">
                            <!-- Teacher Name -->
                            <div class="mb-3">
                                <label class="form-label">
                                    <i class="fas fa-user"></i>
                                    Teacher Name
                                </label>
                                <input asp-for="Name" 
                                       class="form-control form-control-lg" 
                                       placeholder="e.g. Dr. Ali Ahmed" 
                                       required 
                                       oninput="updatePreview()" />
                                <div class="form-hint">
                                    <i class="fas fa-info-circle"></i>
                                    Include title (Dr., Prof., Mr., Ms.) if applicable
                                </div>
                            </div>

                            <!-- Teacher Type -->
                            <div class="mb-3">
                                <label class="form-label">
                                    <i class="fas fa-user-tie"></i>
                                    Faculty Type
                                </label>
                                <select asp-for="TeacherType" 
                                        class="form-select form-control-lg" 
                                        onchange="updateFacultyType()"
                                        id="teacherTypeSelect">
                                    <option value="Professor">Professor</option>
                                    <option value="Associate Professor">Associate Professor</option>
                                    <option value="Assistant Professor">Assistant Professor</option>
                                    <option value="Lecturer">Lecturer</option>
                                    <option value="Senior Lecturer">Senior Lecturer</option>
                                    <option value="Visiting Faculty">Visiting Faculty</option>
                                    <option value="Lab Instructor">Lab Instructor</option>
                                    <option value="Other">Other</option>
                                </select>
                                <div class="form-hint">
                                    <i class="fas fa-info-circle"></i>
                                    Affects scheduling priority and responsibilities
                                </div>
                            </div>

                            <!-- Faculty Status Indicator -->
                            <div class="mb-3">
                                <label class="form-label">
                                    <i class="fas fa-calendar-check"></i>
                                    Faculty Status
                                </label>
                                <div class="room-capacity-info">
                                    <div style="font-size: 0.85rem; color: #64748b; white-space: nowrap;">
                                        Availability:
                                    </div>
                                    <div class="capacity-indicator">
                                        <div class="capacity-fill" id="availabilityFill" style="width: 100%"></div>
                                    </div>
                                    <div style="font-size: 0.85rem; color: #2c3e50; font-weight: 500;">
                                        <span id="availabilityText">Full-time</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Course Assignments -->
                        <div class="mb-4">
                            <label class="form-label">
                                <i class="fas fa-book"></i>
                                Course Assignments
                            </label>
                            <div class="course-id-input">
                                <input name="AssignedCoursesStr" 
                                       value="@ViewBag.AssignedCoursesStr" 
                                       class="form-control form-control-lg" 
                                       placeholder="Enter course IDs separated by commas (e.g. 1, 2, 5)" 
                                       required 
                                       id="courseIdsInput" />
                                <div class="form-hint">
                                    <i class="fas fa-lightbulb"></i>
                                    Check 'Manage Data' to see available Course IDs
                                </div>
                                
                                <!-- Course ID Tags Display -->
                                <div class="course-tags" id="courseTags">
                                    <!-- Tags will be added here by JavaScript -->
                                </div>
                            </div>
                        </div>

                        <!-- Workload Warning -->
                        <div class="alert" id="workloadWarning" style="display: none; background: rgba(231, 76, 60, 0.05); border-left-color: #e74c3c; color: #c0392b;">
                            <div class="d-flex align-items-center gap-2">
                                <i class="fas fa-exclamation-triangle"></i>
                                <div>
                                    <strong>Workload Alert:</strong> 
                                    <span id="workloadMessage" class="ms-1"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Visiting Faculty Notice -->
                        <div class="alert" id="visitingNotice" style="display: none; background: rgba(243, 156, 18, 0.1); border-left-color: #f39c12; color: #d35400;">
                            <div class="d-flex align-items-center gap-2">
                                <i class="fas fa-clock" style="font-size: 1.25rem;"></i>
                                <div>
                                    <strong>Visiting Faculty Note:</strong> 
                                    <span class="ms-1">Visiting faculty have limited availability. Courses will be scheduled on specific days only.</span>
                                </div>
                            </div>
                        </div>

                        <!-- Warning Alert -->
                        <div class="alert" style="background: rgba(243, 156, 18, 0.1); border-left-color: #f39c12; color: #d35400;">
                            <div class="d-flex align-items-center gap-2">
                                <i class="fas fa-exclamation-triangle"></i>
                                <div>
                                    <strong>Note:</strong> 
                                    <span class="ms-1">Changing course assignments may affect existing timetables. Ensure teacher workload is balanced.</span>
                                </div>
                            </div>
                        </div>

                        <!-- Teacher Preview -->
                        <div class="preview-card">
                            <div class="preview-title">
                                <i class="fas fa-eye"></i>
                                Teacher Preview
                            </div>
                            <div class="preview-content" id="teacherPreview">
                                <div class="preview-item">
                                    <div class="preview-label">Name</div>
                                    <div class="preview-value" id="previewName">@Model.Name</div>
                                </div>
                                <div class="preview-item">
                                    <div class="preview-label">Faculty Type</div>
                                    <div class="preview-value" id="previewType">@Model.TeacherType</div>
                                </div>
                                <div class="preview-item">
                                    <div class="preview-label">Status</div>
                                    <div class="preview-value" id="previewStatus">Full-time</div>
                                </div>
                                <div class="preview-item">
                                    <div class="preview-label">Courses Assigned</div>
                                    <div class="preview-value" id="previewCourses">-</div>
                                </div>
                                <div class="preview-item">
                                    <div class="preview-label">Scheduling Priority</div>
                                    <div class="preview-value" id="previewPriority">High</div>
                                </div>
                            </div>
                        </div>

                        <!-- Form Actions -->
                        <div class="form-actions">
                            <button type="submit" class="btn-submit">
                                <i class="fas fa-save"></i>
                                Update Teacher
                            </button>
                            <a asp-action="Manage" class="btn-back">
                                <i class="fas fa-times"></i>
                                Cancel
                            </a>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Help Section -->
            <div class="card mt-4" style="border: 1px solid #e2e8f0; border-radius: 12px;">
                <div class="card-body">
                    <h5 class="card-title" style="color: #2c3e50;">
                        <i class="fas fa-question-circle text-primary me-2"></i>
                        Teacher Editing Guidelines
                    </h5>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <h6 class="fw-bold" style="color: #e74c3c;">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    Important Notes
                                </h6>
                                <ul class="list-unstyled small mb-0">
                                    <li class="mb-1">
                                        <i class="fas fa-check text-success me-2"></i>
                                        Changes affect scheduled classes
                                    </li>
                                    <li class="mb-1">
                                        <i class="fas fa-check text-success me-2"></i>
                                        Course reassignment may be needed
                                    </li>
                                    <li class="mb-1">
                                        <i class="fas fa-check text-success me-2"></i>
                                        Type changes affect availability
                                    </li>
                                    <li>
                                        <i class="fas fa-check text-success me-2"></i>
                                        Re-generate timetable after updates
                                    </li>
                                </ul>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <h6 class="fw-bold" style="color: #27ae60;">
                                    <i class="fas fa-lightbulb me-2"></i>
                                    Best Practices
                                </h6>
                                <ul class="list-unstyled small mb-0">
                                    <li class="mb-1">
                                        <i class="fas fa-check text-success me-2"></i>
                                        Update before generating schedules
                                    </li>
                                    <li class="mb-1">
                                        <i class="fas fa-check text-success me-2"></i>
                                        Balance workload across teachers
                                    </li>
                                    <li class="mb-1">
                                        <i class="fas fa-check text-success me-2"></i>
                                        Verify course IDs are valid
                                    </li>
                                    <li>
                                        <i class="fas fa-check text-success me-2"></i>
                                        Review changes in preview
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <h6 class="fw-bold" style="color: #2c3e50;">
                            <i class="fas fa-chart-pie me-2"></i>
                            Faculty Workload Standards
                        </h6>
                        <table class="table table-sm mb-0">
                            <thead>
                                <tr>
                                    <th>Faculty Type</th>
                                    <th>Recommended Courses</th>
                                    <th>Scheduling Priority</th>
                                    <th>Availability</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Professor/Associate</td>
                                    <td>2-4 courses</td>
                                    <td>Highest</td>
                                    <td>Full-time</td>
                                </tr>
                                <tr>
                                    <td>Assistant Professor</td>
                                    <td>3-5 courses</td>
                                    <td>High</td>
                                    <td>Full-time</td>
                                </tr>
                                <tr>
                                    <td>Lecturer</td>
                                    <td>4-6 courses</td>
                                    <td>Medium</td>
                                    <td>Full-time</td>
                                </tr>
                                <tr>
                                    <td>Visiting Faculty</td>
                                    <td>1-2 courses</td>
                                    <td>Low</td>
                                    <td>Part-time</td>
                                </tr>
                                <tr>
                                    <td>Lab Instructor</td>
                                    <td>Lab courses only</td>
                                    <td>Medium</td>
                                    <td>Full/Part-time</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const teacherTypeSelect = document.getElementById('teacherTypeSelect');
        const visitingNotice = document.getElementById('visitingNotice');
        const workloadWarning = document.getElementById('workloadWarning');
        const courseIdsInput = document.getElementById('courseIdsInput');
        const courseTags = document.getElementById('courseTags');
        const availabilityFill = document.getElementById('availabilityFill');
        const availabilityText = document.getElementById('availabilityText');
        
        // Set initial teacher type from model
        teacherTypeSelect.value = '@Model.TeacherType';
        
        // Initialize course IDs from ViewBag
        if (courseIdsInput.value) {
            updateCourseTags();
        }
        
        // Parse and display course IDs as tags
        function updateCourseTags() {
            const input = courseIdsInput.value;
            const courseIds = input.split(',').filter(id => id.trim() !== '');
            
            courseTags.innerHTML = '';
            courseIds.forEach(id => {
                const tag = document.createElement('span');
                tag.className = 'course-tag';
                tag.innerHTML = `<i class="fas fa-hashtag"></i>${id.trim()}`;
                courseTags.appendChild(tag);
            });
            
            updateWorkloadWarning();
            updatePreview();
        }
        
        courseIdsInput.addEventListener('input', updateCourseTags);
        
        // Update faculty type and availability
        window.updateFacultyType = function() {
            const teacherType = teacherTypeSelect.value;
            const isVisiting = teacherType === 'Visiting Faculty';
            const isLabInstructor = teacherType === 'Lab Instructor';
            
            // Show/hide visiting notice
            visitingNotice.style.display = isVisiting ? 'block' : 'none';
            
            // Update availability indicator
            if (isVisiting) {
                availabilityFill.style.width = '40%';
                availabilityFill.style.background = 'linear-gradient(90deg, #f39c12, #e67e22)';
                availabilityText.textContent = 'Part-time';
            } else if (isLabInstructor) {
                availabilityFill.style.width = '70%';
                availabilityFill.style.background = 'linear-gradient(90deg, #3498db, #2980b9)';
                availabilityText.textContent = 'Flexible';
            } else {
                availabilityFill.style.width = '100%';
                availabilityFill.style.background = 'linear-gradient(90deg, #2ecc71, #27ae60)';
                availabilityText.textContent = 'Full-time';
            }
            
            updateWorkloadWarning();
            updatePreview();
        };
        
        // Update workload warning
        function updateWorkloadWarning() {
            const teacherType = teacherTypeSelect.value;
            const courseIds = courseIdsInput.value.split(',').filter(id => id.trim() !== '');
            const courseCount = courseIds.length;
            
            workloadWarning.style.display = 'none';
            
            if (courseCount === 0) return;
            
            let message = '';
            let showWarning = false;
            
            // Define workload limits based on faculty type
            const workloadLimits = {
                'Professor': { min: 2, max: 4 },
                'Associate Professor': { min: 2, max: 4 },
                'Assistant Professor': { min: 3, max: 5 },
                'Lecturer': { min: 4, max: 6 },
                'Senior Lecturer': { min: 4, max: 6 },
                'Visiting Faculty': { min: 1, max: 2 },
                'Lab Instructor': { min: 1, max: 3 },
                'Other': { min: 1, max: 5 }
            };
            
            const limits = workloadLimits[teacherType] || { min: 1, max: 5 };
            
            if (courseCount < limits.min) {
                message = `${teacherType} assigned ${courseCount} courses. Minimum recommended is ${limits.min} courses.`;
                showWarning = true;
            } else if (courseCount > limits.max) {
                message = `${teacherType} assigned ${courseCount} courses. Maximum recommended is ${limits.max} courses.`;
                showWarning = true;
            } else if (teacherType === 'Lab Instructor' && courseCount > 2) {
                message = `Lab Instructor assigned ${courseCount} courses. Lab instructors typically handle lab courses only.`;
                showWarning = true;
            }
            
            if (showWarning) {
                workloadWarning.style.display = 'block';
                document.getElementById('workloadMessage').textContent = message;
            }
        }
        
        // Update preview function
        window.updatePreview = function() {
            const nameInput = document.querySelector('input[asp-for="Name"]');
            const teacherType = teacherTypeSelect.value;
            const courseIds = courseIdsInput.value.split(',').filter(id => id.trim() !== '');
            
            // Update preview values
            document.getElementById('previewName').textContent = nameInput.value || '@Model.Name';
            document.getElementById('previewType').textContent = teacherType || '@Model.TeacherType';
            document.getElementById('previewStatus').textContent = teacherType === 'Visiting Faculty' ? 'Part-time' : 
                                                                   teacherType === 'Lab Instructor' ? 'Flexible' : 'Full-time';
            document.getElementById('previewCourses').textContent = courseIds.length > 0 ? 
                courseIds.length + ' courses' : 'None assigned';
            
            // Update scheduling priority
            let priority = 'Medium';
            if (teacherType.includes('Professor')) {
                priority = 'Highest';
            } else if (teacherType === 'Senior Lecturer' || teacherType === 'Lecturer') {
                priority = 'High';
            } else if (teacherType === 'Visiting Faculty') {
                priority = 'Low';
            }
            document.getElementById('previewPriority').textContent = priority;
        };
        
        // Initialize preview and settings
        updateFacultyType();
        updateCourseTags();
        updatePreview();
        
        // Form validation
        const form = document.getElementById('editTeacherForm');
        form.addEventListener('submit', function(e) {
            const name = document.querySelector('input[asp-for="Name"]').value;
            const teacherType = teacherTypeSelect.value;
            const courseIdsStr = document.getElementById('courseIdsInput').value;
            
            // Basic validation
            if (!name || !teacherType || !courseIdsStr) {
                e.preventDefault();
                showAlert('Please fill in all required fields.', 'error');
                return false;
            }
            
            // Validate course IDs format
            const courseIdArray = courseIdsStr.split(',').filter(id => id.trim() !== '');
            const invalidIds = courseIdArray.filter(id => isNaN(id) || id.trim() === '');
            if (invalidIds.length > 0) {
                e.preventDefault();
                showAlert('Please enter valid numeric course IDs.', 'error');
                return false;
            }
            
            // Validate workload based on faculty type
            const courseCount = courseIdArray.length;
            const originalCourses = '@ViewBag.AssignedCoursesStr'.split(',').filter(id => id.trim() !== '');
            const originalCourseCount = originalCourses.length;
            
            // Warn about significant course count changes
            if (Math.abs(courseCount - originalCourseCount) > 2) {
                if (!confirm('⚠️ Note: Changing course assignments from ' + originalCourseCount + ' to ' + courseCount + 
                           ' courses.\n\nThis significantly changes teacher workload.\n\nContinue?')) {
                    e.preventDefault();
                    return false;
                }
            }
            
            // Check workload limits
            const isVisiting = teacherType === 'Visiting Faculty';
            const isLabInstructor = teacherType === 'Lab Instructor';
            
            if (isVisiting && courseCount > 3) {
                if (!confirm('⚠️ Warning: Visiting faculty assigned ' + courseCount + ' courses.\n\nVisiting faculty typically handle 1-2 courses.\n\nContinue anyway?')) {
                    e.preventDefault();
                    return false;
                }
            } else if (isLabInstructor && courseCount > 4) {
                if (!confirm('⚠️ Warning: Lab Instructor assigned ' + courseCount + ' courses.\n\nLab instructors typically handle lab courses only.\n\nContinue anyway?')) {
                    e.preventDefault();
                    return false;
                }
            } else if (!isVisiting && !isLabInstructor && courseCount > 7) {
                if (!confirm('⚠️ Warning: ' + teacherType + ' assigned ' + courseCount + ' courses.\n\nMaximum recommended is 6 courses.\n\nContinue anyway?')) {
                    e.preventDefault();
                    return false;
                }
            }
            
            return true;
        });
        
        // Helper function to show alerts
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type === 'error' ? 'danger' : 'success'} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            
            const formBody = document.querySelector('.form-body');
            const existingAlert = formBody.querySelector('.alert');
            if (existingAlert && !existingAlert.classList.contains('form-alert')) {
                existingAlert.remove();
            }
            
            formBody.insertBefore(alertDiv, formBody.firstChild);
            
            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentElement) {
                    alertDiv.remove();
                }
            }, 5000);
        }
        
        // Add input focus effects
        const inputs = document.querySelectorAll('.form-control, .form-select');
        inputs.forEach(input => {
            input.addEventListener('focus', function() {
                this.parentElement.style.transform = 'translateY(-2px)';
            });
            
            input.addEventListener('blur', function() {
                this.parentElement.style.transform = 'translateY(0)';
            });
        });
        
        // Auto-suggest typical workload based on faculty type
        teacherTypeSelect.addEventListener('change', function() {
            const type = this.value;
            const currentCourses = courseIdsInput.value.split(',').filter(id => id.trim() !== '').length;
            
            if (currentCourses === 0) {
                let suggestion = '';
                if (type === 'Visiting Faculty') {
                    suggestion = '1-2 courses recommended';
                } else if (type === 'Lab Instructor') {
                    suggestion = 'Lab courses only';
                } else if (type.includes('Professor')) {
                    suggestion = '3-4 courses typical';
                } else {
                    suggestion = '4-5 courses typical';
                }
                courseIdsInput.setAttribute('placeholder', suggestion);
            }
        });
        
        // Initialize placeholder based on current teacher type
        const initialType = teacherTypeSelect.value;
        let initialSuggestion = '';
        if (initialType === 'Visiting Faculty') {
            initialSuggestion = '1-2 courses recommended';
        } else if (initialType === 'Lab Instructor') {
            initialSuggestion = 'Lab courses only';
        } else if (initialType.includes('Professor')) {
            initialSuggestion = '3-4 courses typical';
        } else {
            initialSuggestion = '4-5 courses typical';
        }
        if (!courseIdsInput.value) {
            courseIdsInput.setAttribute('placeholder', initialSuggestion);
        }
    });
</script>