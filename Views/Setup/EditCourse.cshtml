@model dsa_project.Models.Course

@{
    ViewData["Title"] = "Edit Course";
}

<link rel="stylesheet" href="~/css/main.css">
<link rel="stylesheet" href="~/css/components.css">
<link rel="stylesheet" href="~/css/forms.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<div class="form-section">
    <div class="container">
        <div class="form-container">
            <!-- Form Steps -->
            <div class="form-steps mb-4">
                <div class="form-step">
                    <div class="step-number active">1</div>
                    <div class="step-label">Course Info</div>
                </div>
                <div class="form-step">
                    <div class="step-number">2</div>
                    <div class="step-label">Type & Credits</div>
                </div>
                <div class="form-step">
                    <div class="step-number">3</div>
                    <div class="step-label">Review & Update</div>
                </div>
            </div>

            <!-- Main Form Card -->
            <div class="form-card form-course">
                <div class="form-header">
                    <h1 class="form-title">
                        <i class="fas fa-edit"></i>
                        Edit Course
                    </h1>
                    <div class="text-center mt-2" style="color: rgba(255,255,255,0.9); font-size: 0.9rem;">
                        <i class="fas fa-info-circle"></i>
                        Editing Course ID: <strong>#@Model.Id</strong>
                    </div>
                </div>

                <div class="form-body">
                    <form asp-action="EditCourse" method="post" id="editCourseForm">
                        <input type="hidden" asp-for="Id" />
                        
                        <div class="form-grid">
                            <!-- Course Title -->
                            <div class="mb-3">
                                <label class="form-label">
                                    <i class="fas fa-heading"></i>
                                    Course Title
                                </label>
                                <input asp-for="Title" 
                                       class="form-control form-control-lg" 
                                       placeholder="e.g. Data Structures & Algorithms" 
                                       required 
                                       oninput="updatePreview()" />
                                <div class="form-hint">
                                    <i class="fas fa-info-circle"></i>
                                    Full course title as it appears in curriculum
                                </div>
                            </div>

                            <!-- Credit Hours -->
                            <div class="mb-3">
                                <label class="form-label">
                                    <i class="fas fa-clock"></i>
                                    Credit Hours
                                </label>
                                <input asp-for="CreditHours" 
                                       type="number" 
                                       class="form-control form-control-lg" 
                                       placeholder="e.g. 3" 
                                       required 
                                       min="1" 
                                       max="5"
                                       oninput="updatePreview()" />
                                <div class="form-hint">
                                    <i class="fas fa-info-circle"></i>
                                    Total credit hours for this course
                                </div>
                                
                                <!-- Credit Type Indicator -->
                                <div class="room-capacity-info mt-2">
                                    <div style="font-size: 0.85rem; color: #64748b; white-space: nowrap;">
                                        Credits:
                                    </div>
                                    <div class="capacity-indicator">
                                        <div class="capacity-fill" id="creditHoursFill" style="width: 0%"></div>
                                    </div>
                                    <div style="font-size: 0.85rem; color: #2c3e50; font-weight: 500;">
                                        <span id="creditHoursText">0</span> hours
                                    </div>
                                </div>
                            </div>

                            <!-- Course Type Selection -->
                            <div class="mb-4">
                                <label class="form-label">
                                    <i class="fas fa-flask"></i>
                                    Course Type
                                </label>
                                <div class="form-type-selector">
                                    <div class="form-type-option @(!Model.IsLab ? "active" : "")" 
                                         onclick="selectCourseType('theory')" 
                                         id="theoryOption">
                                        <i class="fas fa-book"></i>
                                        <div>Theory Course</div>
                                        <small class="text-muted">Regular lecture sessions</small>
                                    </div>
                                    <div class="form-type-option @(Model.IsLab ? "active" : "")" 
                                         onclick="selectCourseType('lab')" 
                                         id="labOption">
                                        <i class="fas fa-flask"></i>
                                        <div>Laboratory Course</div>
                                        <small class="text-muted">Practical/lab sessions</small>
                                    </div>
                                </div>
                                <input type="hidden" asp-for="IsLab" id="isLabInput" value="@Model.IsLab.ToString().ToLower()" />
                                <div class="form-hint mt-2">
                                    <i class="fas fa-lightbulb"></i>
                                    <span id="typeHint">
                                        @(Model.IsLab ? "Lab courses require 3-hour continuous slots in Lab rooms." : "Theory courses split into 2+1 hour slots.")
                                    </span>
                                </div>
                            </div>
                        </div>

                        <!-- Lab Hours Info (Shown only for lab courses) -->
                        <div class="lab-hours-field" id="labHoursField" style="@(Model.IsLab ? "display: block;" : "display: none;")">
                            <div class="d-flex align-items-center gap-3">
                                <div style="font-size: 2rem; color: #e74c3c;">
                                    <i class="fas fa-flask"></i>
                                </div>
                                <div>
                                    <h6 class="mb-1" style="color: #c0392b;">
                                        <i class="fas fa-info-circle"></i>
                                        Laboratory Course Information
                                    </h6>
                                    <p class="mb-0" style="color: #666; font-size: 0.9rem;">
                                        This course is scheduled as a 3-hour continuous session in a laboratory room.
                                        Ensure lab rooms are available and have necessary equipment.
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Warning Alert -->
                        <div class="alert" style="background: rgba(243, 156, 18, 0.1); border-left-color: #f39c12; color: #d35400;">
                            <div class="d-flex align-items-center gap-2">
                                <i class="fas fa-exclamation-triangle"></i>
                                <div>
                                    <strong>Note:</strong> 
                                    <span class="ms-1">Changing course type may affect existing timetables. Ensure rooms and schedules are updated accordingly.</span>
                                </div>
                            </div>
                        </div>

                        <!-- Form Actions -->
                        <div class="form-actions">
                            <button type="submit" class="btn-submit">
                                <i class="fas fa-save"></i>
                                Update Course
                            </button>
                            <a asp-action="Manage" class="btn-back">
                                <i class="fas fa-times"></i>
                                Cancel
                            </a>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Help Section -->
            <div class="card mt-4" style="border: 1px solid #e2e8f0; border-radius: 12px;">
                <div class="card-body">
                    <h5 class="card-title" style="color: #2c3e50;">
                        <i class="fas fa-question-circle text-primary me-2"></i>
                        Course Editing Guidelines
                    </h5>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <h6 class="fw-bold" style="color: #e74c3c;">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    Important Notes
                                </h6>
                                <ul class="list-unstyled small mb-0">
                                    <li class="mb-1">
                                        <i class="fas fa-check text-success me-2"></i>
                                        Changes affect all assigned classes
                                    </li>
                                    <li class="mb-1">
                                        <i class="fas fa-check text-success me-2"></i>
                                        Type changes require room reassignment
                                    </li>
                                    <li class="mb-1">
                                        <i class="fas fa-check text-success me-2"></i>
                                        Credit hour changes affect scheduling
                                    </li>
                                    <li>
                                        <i class="fas fa-check text-success me-2"></i>
                                        Re-generate timetable after updates
                                    </li>
                                </ul>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <h6 class="fw-bold" style="color: #27ae60;">
                                    <i class="fas fa-lightbulb me-2"></i>
                                    Best Practices
                                </h6>
                                <ul class="list-unstyled small mb-0">
                                    <li class="mb-1">
                                        <i class="fas fa-check text-success me-2"></i>
                                        Update before generating schedules
                                    </li>
                                    <li class="mb-1">
                                        <i class="fas fa-check text-success me-2"></i>
                                        Verify room availability for labs
                                    </li>
                                    <li class="mb-1">
                                        <i class="fas fa-check text-success me-2"></i>
                                        Check teacher assignments
                                    </li>
                                    <li>
                                        <i class="fas fa-check text-success me-2"></i>
                                        Review changes in preview
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <h6 class="fw-bold" style="color: #2c3e50;">
                            <i class="fas fa-chart-pie me-2"></i>
                            Course Type Standards
                        </h6>
                        <table class="table table-sm mb-0">
                            <thead>
                                <tr>
                                    <th>Course Type</th>
                                    <th>Typical Credits</th>
                                    <th>Slot Duration</th>
                                    <th>Room Type</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Theory Course</td>
                                    <td>3 credits</td>
                                    <td>2h + 1h slots</td>
                                    <td>Classroom</td>
                                </tr>
                                <tr>
                                    <td>Lab Course</td>
                                    <td>1 credit</td>
                                    <td>3h continuous</td>
                                    <td>Laboratory</td>
                                </tr>
                                <tr>
                                    <td>Workshop</td>
                                    <td>2 credits</td>
                                    <td>2h continuous</td>
                                    <td>Lab/Classroom</td>
                                </tr>
                                <tr>
                                    <td>Seminar</td>
                                    <td>1 credit</td>
                                    <td>1h slot</td>
                                    <td>Seminar Room</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize course type selection
        const isLabInput = document.getElementById('isLabInput');
        const labHoursField = document.getElementById('labHoursField');
        const typeHint = document.getElementById('typeHint');
        const creditHoursFill = document.getElementById('creditHoursFill');
        const creditHoursText = document.getElementById('creditHoursText');
        
        // Update credit hours indicator
        function updateCreditHoursIndicator(hours) {
            const creditHours = parseInt(hours) || 0;
            
            // Calculate percentage (max 5 for 100%)
            const percentage = Math.min((creditHours / 5) * 100, 100);
            creditHoursFill.style.width = percentage + '%';
            creditHoursText.textContent = creditHours;
            
            // Update color based on credit hours
            if (creditHours === 1) {
                creditHoursFill.style.background = 'linear-gradient(90deg, #3498db, #2980b9)';
            } else if (creditHours === 2) {
                creditHoursFill.style.background = 'linear-gradient(90deg, #2ecc71, #27ae60)';
            } else if (creditHours === 3) {
                creditHoursFill.style.background = 'linear-gradient(90deg, #f39c12, #e67e22)';
            } else if (creditHours >= 4) {
                creditHoursFill.style.background = 'linear-gradient(90deg, #e74c3c, #c0392b)';
            }
        }
        
        // Function to select course type
        window.selectCourseType = function(type) {
            const theoryOption = document.getElementById('theoryOption');
            const labOption = document.getElementById('labOption');
            
            // Update UI
            theoryOption.classList.remove('active');
            labOption.classList.remove('active');
            
            if (type === 'theory') {
                theoryOption.classList.add('active');
                isLabInput.value = 'false';
                labHoursField.style.display = 'none';
                typeHint.innerHTML = 'Theory courses split into 2+1 hour slots. Can be scheduled in regular classrooms.';
            } else {
                labOption.classList.add('active');
                isLabInput.value = 'true';
                labHoursField.style.display = 'block';
                typeHint.innerHTML = 'Lab courses require 3-hour continuous slots in laboratory rooms with special equipment.';
            }
            
            updatePreview();
        };
        
        // Initialize course type based on model
        if (@Model.IsLab.ToString().ToLower() === 'true') {
            selectCourseType('lab');
        } else {
            selectCourseType('theory');
        }
        
        // Update preview function
        window.updatePreview = function() {
            const titleInput = document.querySelector('input[asp-for="Title"]');
            const hoursInput = document.querySelector('input[asp-for="CreditHours"]');
            const isLab = isLabInput.value === 'true';
            const hours = parseInt(hoursInput.value) || @Model.CreditHours;
            
            // Update preview values
            document.getElementById('previewTitle').textContent = titleInput.value || '@Model.Title';
            document.getElementById('previewHours').textContent = hours ? hours + ' credits' : '@Model.CreditHours credits';
            document.getElementById('previewType').textContent = isLab ? 'Laboratory' : 'Theory';
            document.getElementById('previewDuration').textContent = isLab ? '3 hours continuous' : 'Split into multiple slots';
            document.getElementById('previewRoomType').textContent = isLab ? 'Laboratory Room' : 'Regular Classroom';
            
            // Update credit hours indicator
            updateCreditHoursIndicator(hours);
            
            // Show warning for lab courses with high credits
            if (isLab && hours > 2) {
                const warning = document.querySelector('.alert');
                if (warning) {
                    warning.innerHTML = `
                        <div class="d-flex align-items-center gap-2">
                            <i class="fas fa-exclamation-triangle"></i>
                            <div>
                                <strong>Warning:</strong> 
                                <span class="ms-1">Lab courses with ${hours} credit hours are unusual. Lab courses typically have 1 credit hour.</span>
                            </div>
                        </div>
                    `;
                    warning.style.background = 'rgba(231, 76, 60, 0.1)';
                    warning.style.borderLeftColor = '#e74c3c';
                    warning.style.color = '#c0392b';
                }
            }
        };
        
        // Initialize preview
        updatePreview();
        
        // Form validation
        const form = document.getElementById('editCourseForm');
        form.addEventListener('submit', function(e) {
            const title = document.querySelector('input[asp-for="Title"]').value;
            const hours = document.querySelector('input[asp-for="CreditHours"]').value;
            
            // Basic validation
            if (!title || !hours) {
                e.preventDefault();
                showAlert('Please fill in all required fields.', 'error');
                return false;
            }
            
            const creditHours = parseInt(hours);
            if (creditHours < 1 || creditHours > 5) {
                e.preventDefault();
                showAlert('Please enter valid credit hours (1-5).', 'error');
                return false;
            }
            
            const isLab = isLabInput.value === 'true';
            const originalIsLab = @Model.IsLab.ToString().ToLower() === 'true';
            const originalHours = @Model.CreditHours;
            
            // Warn about type changes
            if (isLab !== originalIsLab) {
                if (!confirm('⚠️ Warning: Changing course type from ' + (originalIsLab ? 'Lab' : 'Theory') + ' to ' + (isLab ? 'Lab' : 'Theory') + 
                           '.\n\nThis affects:\n• Room assignments\n• Slot durations\n• Teacher schedules\n\nAre you sure you want to change the course type?')) {
                    e.preventDefault();
                    return false;
                }
            }
            
            // Warn about credit hour changes
            if (creditHours !== originalHours) {
                if (!confirm('⚠️ Note: Changing credit hours from ' + originalHours + ' to ' + creditHours + 
                           '.\n\nThis affects scheduling slots.\n\nContinue?')) {
                    e.preventDefault();
                    return false;
                }
            }
            
            // Validate lab course credit hours
            if (isLab && creditHours > 2) {
                if (!confirm('⚠️ Warning: Lab courses with more than 2 credit hours are unusual.\n\nLab courses typically have 1 credit hour.\n\nAre you sure?')) {
                    e.preventDefault();
                    return false;
                }
            }
            
            // Validate theory course credit hours
            if (!isLab && creditHours === 1) {
                if (!confirm('⚠️ Note: Theory courses with only 1 credit hour are unusual.\n\nTheory courses typically have 3 credit hours.\n\nContinue?')) {
                    e.preventDefault();
                    return false;
                }
            }
            
            return true;
        });
        
        // Helper function to show alerts
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type === 'error' ? 'danger' : 'success'} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            
            const formBody = document.querySelector('.form-body');
            const existingAlert = formBody.querySelector('.alert');
            if (existingAlert && !existingAlert.classList.contains('form-alert')) {
                existingAlert.remove();
            }
            
            formBody.insertBefore(alertDiv, formBody.firstChild);
            
            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentElement) {
                    alertDiv.remove();
                }
            }, 5000);
        }
        
        // Add input focus effects
        const inputs = document.querySelectorAll('.form-control');
        inputs.forEach(input => {
            input.addEventListener('focus', function() {
                this.parentElement.style.transform = 'translateY(-2px)';
            });
            
            input.addEventListener('blur', function() {
                this.parentElement.style.transform = 'translateY(0)';
            });
        });
        
        // Auto-suggest credit hours based on course type
        const hoursInput = document.querySelector('input[asp-for="CreditHours"]');
        hoursInput.addEventListener('focus', function() {
            const isLab = isLabInput.value === 'true';
            if (isLab) {
                this.setAttribute('placeholder', 'Typically 1 credit for lab courses');
            } else {
                this.setAttribute('placeholder', 'Typically 3 credits for theory courses');
            }
        });
        
        // Auto-detect course type from title
        const titleInput = document.querySelector('input[asp-for="Title"]');
        titleInput.addEventListener('blur', function() {
            const title = this.value.toLowerCase();
            if (title.includes('lab') || title.includes('practical') || title.includes('workshop')) {
                selectCourseType('lab');
            } else if (title.includes('theory') || title.includes('lecture') || title.includes('seminar')) {
                selectCourseType('theory');
            }
        });
    });
</script>