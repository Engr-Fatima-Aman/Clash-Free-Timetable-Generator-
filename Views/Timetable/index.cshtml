@using System.Linq
@model IEnumerable<IGrouping<dynamic, dsa_project.Models.TimetableAssignment>>

@{
    ViewData["Title"] = "Academic Timetable";
}

<link rel="stylesheet" href="~/css/main.css">
<link rel="stylesheet" href="~/css/components.css">
<link rel="stylesheet" href="~/css/timetable.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<div class="timetable-section">
    <div class="container">
        <!-- Header -->
        <div class="timetable-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="timetable-title">Academic Timetable</h1>
                    <p class="timetable-subtitle">Generated using advanced backtracking algorithm</p>
                </div>
                <div class="badge" style="background: rgba(255,255,255,0.2); color: white; font-size: 0.9rem; padding: 0.5rem 1rem;">
                    <i class="fas fa-check-circle me-2"></i> No Conflicts
                </div>
            </div>
        </div>

        <!-- Controls -->
        <div class="timetable-controls no-print">
            <div class="control-buttons">
                <button onclick="window.print()" class="btn btn-primary">
                    <i class="fas fa-print me-2"></i> Print Timetable
                </button>
                <button onclick="exportToPDF()" class="btn btn-outline">
                    <i class="fas fa-file-pdf me-2"></i> Export PDF
                </button>
                <button onclick="toggleAllSections()" class="btn btn-outline">
                    <i class="fas fa-expand me-2"></i> Expand All
                </button>
            </div>
            <div class="filter-options">
                <select class="form-select" style="width: 200px;" onchange="filterByDay(this.value)">
                    <option value="">All Days</option>
                    <option value="Monday">Monday</option>
                    <option value="Tuesday">Tuesday</option>
                    <option value="Wednesday">Wednesday</option>
                    <option value="Thursday">Thursday</option>
                    <option value="Friday">Friday</option>
                </select>
                <input type="text" class="form-control" placeholder="Search course or teacher..." 
                       style="width: 250px;" onkeyup="searchTimetable(this.value)">
            </div>
        </div>

        <!-- Stats -->
        <div class="timetable-stats no-print">
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-content">
                    <h4>Total Classes</h4>
                    <p>@Model.Count()</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-book"></i>
                </div>
                <div class="stat-content">
                    <h4>Total Courses</h4>
                    <p>@Model.SelectMany(g => g).Select(x => x.CourseName).Distinct().Count()</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-chalkboard-teacher"></i>
                </div>
                <div class="stat-content">
                    <h4>Teachers Involved</h4>
                    <p>@Model.SelectMany(g => g).Select(x => x.TeacherName).Distinct().Count()</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-door-open"></i>
                </div>
                <div class="stat-content">
                    <h4>Rooms Used</h4>
                    <p>@Model.SelectMany(g => g).Select(x => x.RoomName).Distinct().Count()</p>
                </div>
            </div>
        </div>

        <!-- Day Navigation -->
        <div class="day-navigation no-print">
            <button class="day-button active" onclick="showAllDays()">All Days</button>
            <button class="day-button" onclick="filterDay('Monday')">Monday</button>
            <button class="day-button" onclick="filterDay('Tuesday')">Tuesday</button>
            <button class="day-button" onclick="filterDay('Wednesday')">Wednesday</button>
            <button class="day-button" onclick="filterDay('Thursday')">Thursday</button>
            <button class="day-button" onclick="filterDay('Friday')">Friday</button>
        </div>

        @if (!Model.Any())
        {
            <div class="empty-state">
                <i class="fas fa-calendar-times"></i>
                <h3>No Timetable Generated</h3>
                <p>Please generate a timetable first to view the schedule.</p>
                <a href="/Timetable/Generate" class="btn btn-primary mt-3">
                    <i class="fas fa-bolt me-2"></i> Generate Timetable
                </a>
            </div>
        }

        <!-- Timetable Sections -->
        @{ 
            int sectionIdx = 0;
            var days = new[] { "Monday", "Tuesday", "Wednesday", "Thursday", "Friday" };
        }
        
        @foreach (var classGroup in Model)
        {
            var className = classGroup.Key.ClassName?.ToString() ?? "Unnamed Class";
            var assignments = classGroup.OrderBy(x => GetDayOrder(x.TimeSlotInfo)).ThenBy(x => x.TimeSlotId).ToList();
            
            <div class="class-section @(sectionIdx > 0 ? "page-break" : "")" id="class-@sectionIdx">
                <div class="class-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h3 class="class-name">
                            <i class="fas fa-users-class"></i>
                            @className
                        </h3>
                        <span class="badge" style="background: rgba(255,255,255,0.2); color: white;">
                            @assignments.Count sessions
                        </span>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="timetable-table">
                        <thead>
                            <tr>
                                <th>Day & Time</th>
                                <th>Course</th>
                                <th>Instructor</th>
                                <th>Location</th>
                                <th>Type</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in assignments)
                            {
                                var isLab = item.CourseName?.ToLower().Contains("lab") == true || 
                                           item.RoomName?.ToLower().Contains("lab") == true;
                                
                                <tr class="timetable-row" data-day="@GetDayFromSlot(item.TimeSlotInfo)">
                                    <td>
                                        <div class="time-slot">
                                            <i class="far fa-clock me-2"></i>
                                            @item.TimeSlotInfo
                                        </div>
                                    </td>
                                    <td>
                                        <div class="@(isLab ? "course-lab" : "course-lecture")">
                                            @item.CourseName
                                        </div>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center gap-2">
                                            <div style="width: 32px; height: 32px; background: #f1f5f9; border-radius: 50%; 
                                                        display: flex; align-items: center; justify-content: center; color: #64748b;">
                                                <i class="fas fa-user"></i>
                                            </div>
                                            <span>@item.TeacherName</span>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="room-badge @(isLab ? "room-lab" : "room-lecture")">
                                            <i class="fas @(isLab ? "fa-flask" : "fa-door-closed") me-2"></i>
                                            @item.RoomName
                                        </span>
                                    </td>
                                    <td>
                                        @if (isLab)
                                        {
                                            <span class="badge" style="background: rgba(231, 76, 60, 0.1); color: #c0392b;">
                                                Lab Session
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="badge" style="background: rgba(52, 152, 219, 0.1); color: #2980b9;">
                                                Lecture
                                            </span>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
                
                <!-- Day-wise Summary -->
                <div class="no-print" style="padding: 1.5rem; background: #f8fafc; border-top: 1px solid #e2e8f0;">
                    <h5 class="mb-3" style="color: #2c3e50;">
                        <i class="fas fa-chart-pie me-2"></i> Weekly Summary
                    </h5>
                    <div class="row">
                        @foreach (var day in days)
                        {
                            var daySessions = assignments.Count(a => GetDayFromSlot(a.TimeSlotInfo) == day);
                            if (daySessions > 0)
                            {
                                <div class="col-md-2 col-4 mb-2">
                                    <div style="text-align: center; padding: 0.75rem; background: white; border-radius: 8px; border: 1px solid #e2e8f0;">
                                        <div style="font-size: 0.85rem; color: #64748b;">@day</div>
                                        <div style="font-size: 1.5rem; font-weight: 600; color: #2c3e50;">@daySessions</div>
                                        <div style="font-size: 0.75rem; color: #94a3b8;">sessions</div>
                                    </div>
                                </div>
                            }
                        }
                    </div>
                </div>
            </div>
            
            sectionIdx++;
        }

        <!-- Footer Note -->
        <div class="text-center mt-5" style="color: #64748b; font-size: 0.9rem;">
            <p>
                <i class="fas fa-info-circle me-2"></i>
                Timetable generated on @DateTime.Now.ToString("dddd, MMMM dd, yyyy h:mm tt")
            </p>
        </div>
    </div>
</div>

<script>
    // JavaScript for enhanced functionality
    function filterByDay(day) {
        const rows = document.querySelectorAll('.timetable-row');
        const dayButtons = document.querySelectorAll('.day-button');
        
        dayButtons.forEach(btn => btn.classList.remove('active'));
        if (day === '') {
            dayButtons[0].classList.add('active');
        } else {
            Array.from(dayButtons).find(btn => btn.textContent === day)?.classList.add('active');
        }
        
        rows.forEach(row => {
            if (!day || row.getAttribute('data-day') === day) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }
    
    function filterDay(day) {
        filterByDay(day);
    }
    
    function showAllDays() {
        filterByDay('');
    }
    
    function searchTimetable(query) {
        const rows = document.querySelectorAll('.timetable-row');
        const searchTerm = query.toLowerCase();
        
        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(searchTerm) ? '' : 'none';
        });
    }
    
    function toggleAllSections() {
        const sections = document.querySelectorAll('.class-section');
        sections.forEach(section => {
            const rows = section.querySelectorAll('.timetable-row');
            const isHidden = Array.from(rows).some(row => row.style.display === 'none');
            
            rows.forEach(row => {
                row.style.display = isHidden ? '' : 'none';
            });
        });
    }
    
    function exportToPDF() {
        // In a real application, this would call a backend API to generate PDF
        alert('PDF export feature would be implemented with a backend service.');
        // window.location.href = '/Timetable/ExportPDF';
    }
    
    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        // Add animation to table rows
        const rows = document.querySelectorAll('.timetable-row');
        rows.forEach((row, index) => {
            row.style.animationDelay = `${index * 0.05}s`;
        });
    });
</script>

@functions {
    private int GetDayOrder(string info) {
        if (string.IsNullOrEmpty(info)) return 6;
        if (info.Contains("Monday")) return 1;
        if (info.Contains("Tuesday")) return 2;
        if (info.Contains("Wednesday")) return 3;
        if (info.Contains("Thursday")) return 4;
        if (info.Contains("Friday")) return 5;
        return 6;
    }
    
    private string GetDayFromSlot(string info) {
        if (string.IsNullOrEmpty(info)) return "Unknown";
        if (info.Contains("Monday")) return "Monday";
        if (info.Contains("Tuesday")) return "Tuesday";
        if (info.Contains("Wednesday")) return "Wednesday";
        if (info.Contains("Thursday")) return "Thursday";
        if (info.Contains("Friday")) return "Friday";
        return "Unknown";
    }
}